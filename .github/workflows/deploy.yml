name: ðŸš€ Deploy to Production

# Runs automatically every time you push to main branch
on:
  push:
    branches:
      - main

jobs:
  deploy:
    name: Deploy to Server
    runs-on: ubuntu-latest

    steps:
      # Step 1: Show which commit is being deployed
      - name: ðŸ“¦ Checkout code
        uses: actions/checkout@v4

      # Step 2: SSH into the server and deploy
      - name: ðŸ”‘ Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: 22
          script: |
            echo "=== Navigating to project folder ==="
            cd /home/ubuntu/docker-proj/Anandicecream

            echo "=== Pulling latest code from main ==="
            git pull origin main

            echo "=== Rebuilding Docker containers ==="
            sudo docker compose --env-file .env.production up -d --build

            echo "=== Running database migrations ==="
            sudo docker compose exec -T web python manage.py migrate --noinput

            echo "âœ… Deployment complete!"
